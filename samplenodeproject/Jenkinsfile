pipeline {
    agent any

    environment {
        APP_VM = "51.145.115.179"
    }

    stages {

        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/LCox3236/QA-DockerandJenkins'
            }
        }

        stage('Install & Test') {
            steps {
                sh '''
                cd samplenodeproject
                echo "Installing dependencies and running tests..."
                npm install
                npm test
                '''
            }
        }

        // stage('Terraform Init & Plan') {
        //     steps {
        //         input "Plan Terraform changes?" // Manual approval (optional)
        //         catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
        //             sh '''
        //             echo "Initializing Terraform..."
        //             cd terraform
        //             terraform init
        //             terraform plan -out=tfplan
        //             '''
        //         }
        //     }
        // }

        // stage('Terraform Apply') {
        //     steps {
        //         input "Apply Terraform changes?" // Manual approval (optional)
        //         catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
        //             sh '''
        //             echo "Applying Terraform changes..."
        //             cd terraform
        //             terraform apply -auto-approve tfplan
        //             '''
        //         }
        //     }
        // }


        stage('Deploy App') {
            steps {
                sshagent(credentials: ['azuressh']) {
                    sh '''
                    ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null azureuser@${APP_VM} "sudo mkdir -p /var/www/calculator && sudo chown azureuser:azureuser /var/www/calculator"
                    scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -r ./samplenodeproject azureuser@${APP_VM}:/var/www/calculator
                    ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null azureuser@${APP_VM} "sudo systemctl restart nginx"
                    ssh -v -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null azureuser@${APP_VM} "cd /var/www/calculator && npm start"
                    '''
                }
            }
        }


        stage('Verify Deployment') {
            steps {
                sh '''
                echo "Verifying deployment..."
                curl -f http://${APP_VM}:80 || exit 1
                '''
            }
        }
    }

    post {
        success {
            echo '✅ Deployment successful!'
        }
        failure {
            echo '❌ Deployment failed!'
        }
    }
}
