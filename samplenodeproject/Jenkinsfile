pipeline {
    agent any

    environment {
        APP_VM = '51.145.115.179'
        TERRAFORM_DIR = 'samplenodeproject/terraform' 
    }

    stages {

        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/LCox3236/QA-DockerandJenkins'
            }
        }

        stage('Install & Test') {
            steps {
                sh '''
                cd samplenodeproject
                echo "Installing dependencies and running tests..."
                npm install
                npm test
                '''
            }
        }

        stage('Terraform Init & Plan') {
            steps {
                input "Plan Terraform changes?" // Manual approval (optional)
                catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
                    script {
                        // Use Azure credentials securely from Jenkins
                        withCredentials([
                            string(credentialsId: 'azure-client-id', variable: 'AZURE_CLIENT_ID'),
                            string(credentialsId: 'azure-client-secret', variable: 'AZURE_CLIENT_SECRET'),
                            string(credentialsId: 'azure-tenant-id', variable: 'AZURE_TENANT_ID'),
                            string(credentialsId: 'azure-subscription-id', variable: 'AZURE_SUBSCRIPTION_ID')
                        ]) {
                            echo "Initializing Terraform..."
                            // Set Azure authentication environment variables for Terraform
                            withEnv([
                                "ARM_CLIENT_ID=${AZURE_CLIENT_ID}",
                                "ARM_CLIENT_SECRET=${AZURE_CLIENT_SECRET}",
                                "ARM_TENANT_ID=${AZURE_TENANT_ID}",
                                "ARM_SUBSCRIPTION_ID=${AZURE_SUBSCRIPTION_ID}"
                            ]) {
                                // Run Terraform commands with -var flags to pass the credentials
                                dir(TERRAFORM_DIR) {
                                    sh "terraform init"
                                    sh """
                                        terraform plan -out=tfplan \
                                        -var client_id=${AZURE_CLIENT_ID} \
                                        -var client_secret=${AZURE_CLIENT_SECRET} \
                                        -var tenant_id=${AZURE_TENANT_ID} \
                                        -var subscription_id=${AZURE_SUBSCRIPTION_ID}
                                    """
                                }
                            }
                        }
                    }
                }
            }
        }

        stage('Terraform Apply') {
            steps {
                input "Apply Terraform changes?" // Manual approval (optional)
                catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
                    script {
                        echo "Applying Terraform changes..."
                        sh "terraform apply -auto-approve tfplan"

                        // Capture the output IP address and save it as a Jenkins environment variable
                        def ip = sh(script: 'terraform output -raw public_ip', returnStdout: true).trim()

                        // Check if IP was captured
                        if (ip) {
                            env.PUBLIC_IP = ip
                            echo "Public IP: ${env.PUBLIC_IP}"
                        } else {
                            error "Terraform output 'public_ip' not found."
                        }
                    }
                }
            }
        }
                
            


        stage('Deploy App') {
            steps {
                sshagent(credentials: ['azuressh']) {
                    sh '''
                    # Ensure the target directory exists on the remote server
                    ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null azureuser@${APP_VM} "sudo mkdir -p /var/www/calculator && sudo chown azureuser:azureuser /var/www/calculator"

                    # Deploy the application (copying the contents of samplenodeproject)
                    scp -v -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -r ./samplenodeproject/* azureuser@${APP_VM}:/var/www/calculator

                    # Install Node.js and npm if they are missing
                    ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null azureuser@${APP_VM} "
                    sudo rm -f /etc/apt/sources.list.d/kubernetes.list
                    sudo apt update
                    sudo apt install -y nodejs npm
                    "

                    # Start the Node.js app in the background using nohup
                    ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null azureuser@${APP_VM} "
                    cd /var/www/calculator && npm install && nohup npm start &"
                    
                    # Restart nginx to apply changes
                    ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null azureuser@${APP_VM} "sudo systemctl restart nginx"
                    '''
                }
            }
        }


        stage('Verify Deployment') {
            steps {
                sh '''
                echo "Verifying deployment..."
                curl -f http://${APP_VM}:80 || exit 1
                '''
            }
        }
    }

    post {
        success {
            echo '✅ Deployment successful!'
        }
        failure {
            echo '❌ Deployment failed!'
        }
    }
}
