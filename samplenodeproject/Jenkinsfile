pipeline {
    agent any

    environment {
        APP_VM = "azureuser@51.142.192.35"
    }

    stages {

        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/LCox3236/QA-DockerandJenkins'
            }
        }

        stage('Install & Test') {
            steps {
                sh '''
                cd samplenodeproject
                echo "Installing dependencies and running tests..."
                npm install
                npm test
                '''
            }
        }

        // stage('Terraform Init & Plan') {
        //     steps {
        //         input "Plan Terraform changes?" // Manual approval (optional)
        //         catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
        //             sh '''
        //             echo "Initializing Terraform..."
        //             cd terraform
        //             terraform init
        //             terraform plan -out=tfplan
        //             '''
        //         }
        //     }
        // }

        // stage('Terraform Apply') {
        //     steps {
        //         input "Apply Terraform changes?" // Manual approval (optional)
        //         catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
        //             sh '''
        //             echo "Applying Terraform changes..."
        //             cd terraform
        //             terraform apply -auto-approve tfplan
        //             '''
        //         }
        //     }
        // }


        stage('Deploy App') {
            steps {
                sh '''
                echo "Deploying calculator app to App VM..."
                cd samplenodeproject
                scp -r ./dist ${APP_VM}:/var/www/calculator
                ssh ${APP_VM} "sudo systemctl restart nginx"
                '''
            }
        }

        stage('Verify Deployment') {
            steps {
                sh '''
                echo "Verifying deployment..."
                curl -f http://${APP_VM}:80 || exit 1
                '''
            }
        }
    }

    post {
        success {
            echo '✅ Deployment successful!'
        }
        failure {
            echo '❌ Deployment failed!'
        }
    }
}
