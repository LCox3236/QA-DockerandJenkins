pipeline {
    agent any

    environment {
        APP_VM = "51.145.115.179"
    }

    stages {

        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/LCox3236/QA-DockerandJenkins'
            }
        }

        stage('Install & Test') {
            steps {
                sh '''
                cd samplenodeproject
                echo "Installing dependencies and running tests..."
                npm install
                npm test
                '''
            }
        }

        // stage('Terraform Init & Plan') {
        //     steps {
        //         input "Plan Terraform changes?" // Manual approval (optional)
        //         catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
        //             sh '''
        //             echo "Initializing Terraform..."
        //             cd terraform
        //             terraform init
        //             terraform plan -out=tfplan
        //             '''
        //         }
        //     }
        // }

        // stage('Terraform Apply') {
        //     steps {
        //         input "Apply Terraform changes?" // Manual approval (optional)
        //         catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
        //             sh '''
        //             echo "Applying Terraform changes..."
        //             cd terraform
        //             terraform apply -auto-approve tfplan
        //             '''
        //         }
        //     }
        // }


        stage('Deploy App') {
            steps {
                sshagent(credentials: ['azuressh']) {
                    sh '''
                    # Ensure the target directory exists on the remote server
                    ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null azureuser@${APP_VM} "sudo mkdir -p /var/www/calculator && sudo chown azureuser:azureuser /var/www/calculator"

                    # Deploy the application
                    scp -v -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -r ./samplenodeproject/* azureuser@${APP_VM}:/var/www/calculator

                    # Install Node.js and npm if they are missing (and fix Kubernetes repo issue)
                    ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null azureuser@${APP_VM} "
                    sudo rm -f /etc/apt/sources.list.d/kubernetes.list
                    sudo apt update
                    sudo apt install -y nodejs npm
                    "
                    
                    # Restart nginx to apply changes
                    ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null azureuser@${APP_VM} "sudo systemctl restart nginx"

                    # Start the Node.js app (using pm2 or npm)
                    ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null azureuser@${APP_VM} "cd /var/www/calculator && npm install && pm2 start app.js --name 'calculator' || npm start"
                    '''
                }
            }
        }


        stage('Verify Deployment') {
            steps {
                sh '''
                echo "Verifying deployment..."
                curl -f http://${APP_VM}:80 || exit 1
                '''
            }
        }
    }

    post {
        success {
            echo '✅ Deployment successful!'
        }
        failure {
            echo '❌ Deployment failed!'
        }
    }
}
